<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>IPTV Player</title>

<style>
*{box-sizing:border-box;font-family:Arial,sans-serif}
body{margin:0;background:#111;color:#fff}
.app{display:flex;height:100vh}
.sidebar{width:330px;background:#1c1c1c;padding:10px;overflow-y:auto}
h2,h3{text-align:center;margin:6px 0}
input,button{width:100%;margin-bottom:6px;padding:6px;border:none;border-radius:4px}
button{background:#444;color:#fff;cursor:pointer}
button:hover{background:#555}
ul{list-style:none;padding:0;margin:0}
li{padding:6px;border-bottom:1px solid #333}
li:hover{background:#333}
.channel{display:flex;justify-content:space-between;align-items:center}
.channel span{cursor:pointer;flex:1}
.controls button{width:auto;margin-left:4px;padding:2px 6px}
.player{flex:1;background:black}
video{width:100%;height:100%}
.section{margin-bottom:10px;border-bottom:1px solid #333;padding-bottom:6px}
</style>
</head>

<body>

<div class="app">
  <aside class="sidebar">

    <h2>üì∫ IPTV</h2>

    <input type="file" id="fileInput" accept=".m3u,.m3u8,.md">
    <input type="text" id="urlInput" placeholder="Pegar URL M3U / MD">
    <button onclick="loadFromURL()">Cargar URL</button>

    <input type="text" id="search" placeholder="Buscar canal">

    <div class="section">
      <h3>‚≠ê Favoritos</h3>
      <button onclick="exportMD(favorites,'favoritos.md')">‚¨á Exportar favoritos (.md)</button>
      <ul id="favList"></ul>
    </div>

    <div class="section">
      <h3>üìÉ Canales</h3>
      <button onclick="exportMD(channels,'canales.md')">‚¨á Exportar canales (.md)</button>
      <ul id="channelList"></ul>
    </div>

    <button onclick="clearAll()">üóë Borrar todo</button>

  </aside>

  <main class="player">
    <video id="video" controls autoplay></video>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<script>
let channels=[],favorites=[],hls=null;

const channelList=document.getElementById("channelList");
const favList=document.getElementById("favList");
const video=document.getElementById("video");
const searchInput=document.getElementById("search");

// ===== Persistencia =====
function saveState(){
  localStorage.setItem("iptv_channels",JSON.stringify(channels));
  localStorage.setItem("iptv_favs",JSON.stringify(favorites));
}
function loadState(){
  channels=JSON.parse(localStorage.getItem("iptv_channels")||"[]");
  favorites=JSON.parse(localStorage.getItem("iptv_favs")||"[]");
}

// ===== Parsear M3U / MD =====
function parseM3U(text){
  channels=[];
  const lines=text.split("\n");
  for(let i=0;i<lines.length;i++){
    if(lines[i].startsWith("#EXTINF")){
      const name=lines[i].split(",")[1]?.trim()||"Canal";
      const url=lines[i+1]?.trim();
      if(url?.startsWith("http")) channels.push({name,url});
    }
  }
  saveState();render();
}

// ===== Render =====
function render(){
  renderList(channelList,channels,false);
  renderList(favList,favorites,true);
}

function renderList(el,list,fav){
  el.innerHTML="";
  list.forEach((c,i)=>{
    const li=document.createElement("li");
    const row=document.createElement("div");
    row.className="channel";

    const name=document.createElement("span");
    name.textContent=c.name;
    name.onclick=()=>play(c.url);

    const ctr=document.createElement("div");
    ctr.className="controls";

    if(!fav) ctr.appendChild(btn("‚≠ê",()=>addFav(i)));
    ctr.append(btn("‚Üë",()=>move(list,i,-1)));
    ctr.append(btn("‚Üì",()=>move(list,i,1)));
    ctr.append(btn("‚ùå",()=>remove(list,i)));

    row.append(name,ctr);
    li.appendChild(row);
    el.appendChild(li);
  });
}

function btn(t,f){const b=document.createElement("button");b.textContent=t;b.onclick=f;return b}

// ===== Player =====
function play(url){
  if(hls){hls.destroy();hls=null}
  if(video.canPlayType("application/vnd.apple.mpegurl")){
    video.src=url;
  }else if(Hls.isSupported()){
    hls=new Hls();hls.loadSource(url);hls.attachMedia(video);
  }
}

// ===== Acciones =====
function addFav(i){favorites.push(channels[i]);saveState();render()}
function remove(list,i){list.splice(i,1);saveState();render()}
function move(list,i,d){
  const j=i+d;if(j<0||j>=list.length)return;
  [list[i],list[j]]=[list[j],list[i]];saveState();render();
}
function clearAll(){localStorage.clear();channels=[];favorites=[];render()}

// ===== Buscador =====
searchInput.addEventListener("input",()=>{
  const q=searchInput.value.toLowerCase();
  renderList(channelList,channels.filter(c=>c.name.toLowerCase().includes(q)),false);
});

// ===== Cargas =====
document.getElementById("fileInput").addEventListener("change",e=>{
  const r=new FileReader();r.onload=()=>parseM3U(r.result);
  r.readAsText(e.target.files[0]);
});

async function loadFromURL(){
  try{
    const res=await fetch(document.getElementById("urlInput").value);
    parseM3U(await res.text());
  }catch{alert("No se pudo cargar (CORS o URL inv√°lida)")}
}

// ===== Exportar a MD =====
function exportMD(list,filename){
  let md="#EXTM3U\n\n";
  list.forEach(c=>{
    md+=`#EXTINF:-1,${c.name}\n${c.url}\n\n`;
  });
  const blob=new Blob([md],{type:"text/markdown"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=filename;
  a.click();
}

// ===== Init =====
window.onload=()=>{loadState();render()}
</script>

</body>
</html>
