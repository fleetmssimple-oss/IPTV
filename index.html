<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>IPTV Player</title>

<style>
*{box-sizing:border-box;font-family:Arial,sans-serif}
body{margin:0;background:#111;color:#fff}
.app{display:flex;height:100vh}
.sidebar{width:320px;background:#1c1c1c;padding:10px;overflow-y:auto}
h2,h3{text-align:center;margin:6px 0}
input,button{width:100%;margin-bottom:6px;padding:6px;border:none;border-radius:4px}
button{background:#444;color:#fff;cursor:pointer}
button:hover{background:#555}
ul{list-style:none;padding:0;margin:0}
li{padding:6px;border-bottom:1px solid #333}
li:hover{background:#333}
.channel{display:flex;justify-content:space-between;align-items:center}
.channel span{cursor:pointer;flex:1}
.controls button{width:auto;margin-left:4px;padding:2px 6px}
.player{flex:1;background:black}
video{width:100%;height:100%}
.section{margin-bottom:10px;border-bottom:1px solid #333;padding-bottom:6px}
</style>
</head>

<body>

<div class="app">
  <aside class="sidebar">

    <h2>üì∫ IPTV</h2>

    <input type="file" id="fileInput" accept=".m3u,.m3u8">
    <input type="text" id="urlInput" placeholder="Pegar URL M3U">
    <button onclick="loadFromURL()">Cargar URL</button>

    <input type="text" id="search" placeholder="Buscar canal">

    <div class="section">
      <h3>‚≠ê Favoritos</h3>
      <ul id="favList"></ul>
    </div>

    <div class="section">
      <h3>üìÉ Canales</h3>
      <ul id="channelList"></ul>
    </div>

    <button onclick="clearAll()">üóë Borrar todo</button>

  </aside>

  <main class="player">
    <video id="video" controls autoplay></video>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<script>
let channels = [];
let favorites = [];
let hls = null;

const channelList = document.getElementById("channelList");
const favList = document.getElementById("favList");
const video = document.getElementById("video");
const searchInput = document.getElementById("search");

// ===== Persistencia =====
function saveState(){
  localStorage.setItem("iptv_channels", JSON.stringify(channels));
  localStorage.setItem("iptv_favs", JSON.stringify(favorites));
}
function loadState(){
  channels = JSON.parse(localStorage.getItem("iptv_channels") || "[]");
  favorites = JSON.parse(localStorage.getItem("iptv_favs") || "[]");
}

// ===== Cargar M3U =====
function parseM3U(text){
  channels=[];
  const lines=text.split("\n");
  for(let i=0;i<lines.length;i++){
    if(lines[i].startsWith("#EXTINF")){
      const name=lines[i].split(",")[1]?.trim()||"Canal";
      const url=lines[i+1]?.trim();
      if(url?.startsWith("http")) channels.push({name,url});
    }
  }
  saveState();
  render();
}

// ===== Render =====
function render(){
  renderList(channelList, channels, false);
  renderList(favList, favorites, true);
}

function renderList(el, list, fav){
  el.innerHTML="";
  list.forEach((c,i)=>{
    const li=document.createElement("li");
    const div=document.createElement("div");
    div.className="channel";

    const span=document.createElement("span");
    span.textContent=c.name;
    span.onclick=()=>play(c.url);

    const ctr=document.createElement("div");
    ctr.className="controls";

    if(!fav){
      const star=btn("‚≠ê",()=>addFav(i));
      ctr.appendChild(star);
    }

    const up=btn("‚Üë",()=>move(list,i,-1));
    const down=btn("‚Üì",()=>move(list,i,1));
    const del=btn("‚ùå",()=>remove(list,i));

    ctr.append(up,down,del);
    div.append(span,ctr);
    li.appendChild(div);
    el.appendChild(li);
  });
}

function btn(t,fn){
  const b=document.createElement("button");
  b.textContent=t;b.onclick=fn;
  return b;
}

// ===== Acciones =====
function play(url){
  if(hls){hls.destroy();hls=null;}
  if(video.canPlayType("application/vnd.apple.mpegurl")){
    video.src=url;
  }else if(Hls.isSupported()){
    hls=new Hls();hls.loadSource(url);hls.attachMedia(video);
  }
}

function addFav(i){
  favorites.push(channels[i]);
  saveState();render();
}
function remove(list,i){
  list.splice(i,1);
  saveState();render();
}
function move(list,i,d){
  const j=i+d;
  if(j<0||j>=list.length)return;
  [list[i],list[j]]=[list[j],list[i]];
  saveState();render();
}

function clearAll(){
  localStorage.clear();
  channels=[];favorites=[];
  render();
}

// ===== Buscador =====
searchInput.addEventListener("input",()=>{
  const q=searchInput.value.toLowerCase();
  renderList(channelList,channels.filter(c=>c.name.toLowerCase().includes(q)),false);
});

// ===== Carga archivo / URL =====
document.getElementById("fileInput").addEventListener("change",e=>{
  const r=new FileReader();
  r.onload=()=>parseM3U(r.result);
  r.readAsText(e.target.files[0]);
});

async function loadFromURL(){
  try{
    const res=await fetch(document.getElementById("urlInput").value);
    parseM3U(await res.text());
  }catch{alert("No se pudo cargar la URL (CORS)");}
}

window.onload=()=>{loadState();render();}
</script>

</body>
</html>
