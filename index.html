<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>IPTV Player</title>

<style>
*{box-sizing:border-box;font-family:Arial,sans-serif}
body{margin:0;background:#111;color:#fff}
.app{display:flex;height:100vh}
.sidebar{width:300px;background:#1c1c1c;padding:10px;overflow-y:auto}
.sidebar h2{text-align:center;margin:0 0 10px}
.sidebar input, .sidebar button{
  width:100%;margin-bottom:6px;padding:6px;border:none;border-radius:4px
}
.sidebar button{background:#444;color:#fff;cursor:pointer}
.sidebar button:hover{background:#555}
#channelList{list-style:none;padding:0;margin:0}
#channelList li{padding:6px;cursor:pointer;border-bottom:1px solid #333}
#channelList li:hover{background:#333}
.player{flex:1;background:black}
video{width:100%;height:100%;background:black}
</style>
</head>

<body>

<div class="app">
  <aside class="sidebar">
    <h2>ðŸ“º IPTV</h2>

    <!-- Cargar archivo -->
    <input type="file" id="fileInput" accept=".m3u,.m3u8">

    <!-- Cargar URL -->
    <input type="text" id="urlInput" placeholder="Pegar enlace M3U...">
    <button onclick="loadFromURL()">Cargar desde URL</button>

    <input type="text" id="search" placeholder="Buscar canal...">

    <button onclick="clearSaved()">ðŸ—‘ Borrar lista guardada</button>

    <ul id="channelList"></ul>
  </aside>

  <main class="player">
    <video id="video" controls autoplay></video>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<script>
const fileInput = document.getElementById("fileInput");
const channelList = document.getElementById("channelList");
const searchInput = document.getElementById("search");
const video = document.getElementById("video");
const urlInput = document.getElementById("urlInput");

let channels = [];
let hls = null;

// ===== Cargar desde archivo =====
fileInput.addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    saveList(reader.result);
    parseM3U(reader.result);
  };
  reader.readAsText(file);
});

// ===== Cargar desde URL =====
async function loadFromURL() {
  const url = urlInput.value.trim();
  if (!url) return alert("Pega una URL vÃ¡lida");

  try {
    const res = await fetch(url);
    const text = await res.text();
    saveList(text);
    parseM3U(text);
  } catch (e) {
    alert("No se pudo cargar la lista (CORS o URL invÃ¡lida)");
  }
}

// ===== Guardar en local =====
function saveList(text) {
  localStorage.setItem("iptv_m3u", text);
}

// ===== Recuperar al abrir =====
window.addEventListener("load", () => {
  const saved = localStorage.getItem("iptv_m3u");
  if (saved) parseM3U(saved);
});

// ===== Borrar =====
function clearSaved() {
  localStorage.removeItem("iptv_m3u");
  channelList.innerHTML = "";
  video.src = "";
}

// ===== Parsear M3U =====
function parseM3U(text) {
  channels = [];
  const lines = text.split("\n");

  for (let i = 0; i < lines.length; i++) {
    if (lines[i].startsWith("#EXTINF")) {
      const name = lines[i].split(",")[1]?.trim() || "Canal";
      const url = lines[i + 1]?.trim();
      if (url && url.startsWith("http")) {
        channels.push({ name, url });
      }
    }
  }
  renderList(channels);
}

// ===== Mostrar lista =====
function renderList(list) {
  channelList.innerHTML = "";
  list.forEach(ch => {
    const li = document.createElement("li");
    li.textContent = ch.name;
    li.onclick = () => playChannel(ch.url);
    channelList.appendChild(li);
  });
}

// ===== Reproducir =====
function playChannel(url) {
  if (hls) { hls.destroy(); hls = null; }

  if (video.canPlayType("application/vnd.apple.mpegurl")) {
    video.src = url;
  } else if (Hls.isSupported()) {
    hls = new Hls();
    hls.loadSource(url);
    hls.attachMedia(video);
  } else {
    alert("HLS no soportado");
  }
}

// ===== Buscador =====
searchInput.addEventListener("input", () => {
  const q = searchInput.value.toLowerCase();
  renderList(channels.filter(c => c.name.toLowerCase().includes(q)));
});
</script>

</body>
</html>
